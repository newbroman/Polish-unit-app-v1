<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Polish Food Master v27.0 - Autosave Edition</title>
    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; 
            --primary: #8ab4f8; --masc: #64b5f6; --fem: #f06292; --neut: #81c784;
            --border: #333;
        }
        /* System Theme Detection */
        @media (prefers-color-scheme: light) {
            :root {
                --bg: #f5f5f5; --card: #ffffff; --text: #212121; 
                --primary: #1a73e8; --border: #ddd;
            }
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 0; transition: background 0.3s; }
        .mastery-progress { width: 100%; height: 6px; background: rgba(128,128,128,0.2); position: sticky; top: 0; z-index: 10; }
        #mastery-fill { width: 0%; height: 100%; background: var(--neut); transition: width 0.5s ease; }
        .card { width: 90%; max-width: 450px; background: var(--card); padding: 25px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); margin-top: 20px; border: 1px solid var(--border); position: relative; }
        .phrase-display { font-size: 1.4rem; text-align: center; min-height: 100px; display: flex; flex-direction: column; justify-content: center; margin: 15px 0; font-weight: 600; }
        .opt-btn { width: 100%; padding: 14px; margin-bottom: 10px; border-radius: 14px; border: 2px solid var(--border); background: var(--card); color: var(--text); cursor: pointer; text-align: left; font-size: 1rem; transition: 0.2s; }
        .opt-btn.correct { background: var(--neut) !important; color: #121212 !important; border-color: var(--neut) !important; font-weight: bold; }
        .opt-btn.wrong { background: var(--fem) !important; color: white !important; }
        .top-nav { display: flex; gap: 10px; width: 90%; max-width: 450px; margin-top: 15px; }
        .nav-btn { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid var(--border); font-weight: bold; cursor: pointer; font-size: 0.75rem; background: var(--card); color: var(--text); }
        #overlay { position: fixed; inset: 0; background: var(--bg); z-index: 100; display: flex; justify-content: center; align-items: center; padding: 20px; overflow-y: auto; }
        .instruction-box { background: var(--card); padding: 30px; border-radius: 24px; max-width: 400px; border: 1px solid var(--border); }
        .g-m { color: var(--masc); } .g-f { color: var(--fem); } .g-n { color: var(--neut); }
        .highlight-ans { color: var(--neut); border-bottom: 2px solid var(--neut); }
        .audio-btn { background: none; border: none; cursor: pointer; font-size: 1.3rem; vertical-align: middle; padding: 5px; color: var(--primary); }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 0.85rem; }
        td, th { padding: 8px; border-bottom: 1px solid var(--border); text-align: left; }
    </style>
    <script src="data.js"></script>

</head>
<body onload="checkAutoSave()">

<div class="mastery-progress"><div id="mastery-fill"></div></div>

<div id="overlay">
<div class="instruction-box" id="overlay-content">
    <h2 style="margin-top:0;">How to Play üéÆ</h2>
    <ul style="font-size:0.85rem; padding-left: 20px; margin-bottom: 20px;">
        <li><b>Read</b> the English prompt at the top (e.g., "1.5 kg of Apple").</li>
        <li><b>Identify</b> the correct form of the <b>unit</b> (e.g., kg, bottle, cup) to fill the blank.</li>
        <li><b>Tap</b> the buttons to answer. The text colors help you identify the <b>grammatical gender</b>.</li>
        <li><b>Mastery:</b> Reach 5 correct answers for an item to "master" it and fill your progress bar.</li>
    </ul>

    <h2 style="margin-top:0;">Grammar Rules üáµüá±</h2>
    <table>
        <tr><th>Quantity</th><th>Case of Unit</th></tr>
        <tr><td>1 (jeden/a)</td><td>Nominative Sg.</td></tr>
        <tr><td>2, 3, 4</td><td>Nominative Pl.</td></tr>
        <tr><td>5 - 10</td><td>Genitive Pl.</td></tr>
        <tr><td>0.5 / 1.5</td><td>Genitive Sg.</td></tr>
    </table>

    <div style="margin: 15px 0; border-top: 1px solid var(--border); padding-top: 10px;">
        <p style="font-size:0.85rem; margin-bottom: 8px;"><b>Gender Color Coding:</b></p>
        <div style="display: flex; flex-wrap: wrap; gap: 10px; font-size: 0.8rem; font-weight: bold;">
            <span class="g-m">‚ñ† Masculine (Mƒôski)</span>
            <span class="g-f">‚ñ† Feminine (≈ªe≈Ñski)</span>
            <span class="g-n">‚ñ† Neuter (Nijaki)</span>
        </div>
    </div>

    <p style="font-size:0.85rem;"><b>Note:</b> The product (e.g., water, bread) always stays in the <i>Genitive case</i>.</p>
    
    <button class="nav-btn" style="background:var(--primary); color:white; width:100%; padding:15px; font-size:1rem; border:none; margin-top:10px;" onclick="closeOverlay()">START TRAINING</button>
</div>
</div>

<div class="top-nav">
    <button class="nav-btn" onclick="showHelp()">‚ùì Rules</button>
    <button class="nav-btn" onclick="toggleLang()">üåê EN/PL</button>
    <button class="nav-btn" onclick="resetAll()">üîÑ Reset Progress</button>
</div>

<div class="card">
    <div id="streak-badge" style="text-align:right; font-weight:bold; color:var(--primary);">üî• 0</div>
    <div id="category" style="font-size:0.7rem; color:var(--primary); text-transform:uppercase; font-weight:800; letter-spacing:1px;">...</div>
    <div id="en-translation" style="font-style:italic; color:#888; font-size:0.9rem; margin-top:4px;">...</div>
    <div class="phrase-display">
        <div><span id="phrase-box"></span> <button class="audio-btn" onclick="speakPhrase()">üîä</button></div>
    </div>
    <div id="options"></div>
    <div id="expl" style="display:none; font-size:0.85rem; padding:12px; background:rgba(128,128,128,0.1); border-radius:12px; margin-top:10px; border-left: 4px solid var(--primary);"></div>
</div>

<script>
    let currentLang = 'en', streak = 0, mastery = {}, currentQ = {};

    const numWords = {
        m: ["", "jeden", "dwa", "trzy", "cztery", "piƒôƒá", "sze≈õƒá", "siedem", "osiem", "dziewiƒôƒá", "dziesiƒôƒá"],
        f: ["", "jedna", "dwie", "trzy", "cztery", "piƒôƒá", "sze≈õƒá", "siedem", "osiem", "dziewiƒôƒá", "dziesiƒôƒá"],
        n: ["", "jedno", "dwa", "trzy", "cztery", "piƒôƒá", "sze≈õƒá", "siedem", "osiem", "dziewiƒôƒá", "dziesiƒôƒá"]
    };

    function closeOverlay() { document.getElementById('overlay').style.display = 'none'; if(!currentQ.item) next(); }
    function showHelp() { document.getElementById('overlay').style.display = 'flex'; }
    function toggleLang() { currentLang = (currentLang === 'en' ? 'pl' : 'en'); if(currentQ.item) refreshUI(); }
    function resetAll() { if(confirm("Clear all progress?")) { localStorage.clear(); location.reload(); } }

    function checkAutoSave() {
        const saved = localStorage.getItem('foodMastery_v27');
        if(saved) mastery = JSON.parse(saved);
        updateProgress();
    }

    function updateProgress() {
        const score = Object.values(mastery).reduce((a, b) => a + Math.min(b, 5), 0);
        document.getElementById('mastery-fill').style.width = (score / (foodDb.length * 5) * 100) + "%";
        localStorage.setItem('foodMastery_v27', JSON.stringify(mastery));
    }

    function speakPhrase() {
        const msg = new SpeechSynthesisUtterance(`${currentQ.numTxt} ${currentQ.correct} ${currentQ.item.gs}`);
        msg.lang = 'pl-PL';
        msg.rate = 0.85;
        window.speechSynthesis.speak(msg);
    }

    function next() {
        document.getElementById('expl').style.display = 'none';
        const item = foodDb[Math.floor(Math.random() * foodDb.length)];
        const unitKey = item.u[Math.floor(Math.random() * item.u.length)];
        const unit = units[unitKey];

        // Safety check: if unit is missing in data.js, try again
        if (!unit) { console.error("Missing unit:", unitKey); next(); return; }

        const n = Math.random() > 0.8 ? (Math.random() > 0.5 ? 0.5 : 1.5) : Math.floor(Math.random()*9)+1;

        let numTxt, correct;
        if (n === 0.5) { numTxt = "p√≥≈Ç"; correct = unit.gs; }
        else if (n === 1.5) { numTxt = (unit.g === 'f' ? "p√≥≈Çtorej" : "p√≥≈Çtora"); correct = unit.gs; }
        else {
            numTxt = numWords[unit.g][n];
            if (n === 1) correct = unit.s;
            else if (n >= 2 && n <= 4) correct = unit.pa;
            else correct = unit.pb;
        }

        currentQ = { item, correct, numTxt, n, unit };
        refreshUI();
        speakPhrase();
    }



    function refreshUI() {
        document.getElementById('category').innerText = currentQ.item.cat[currentLang];
        document.getElementById('en-translation').innerText = `${currentQ.n} ${currentQ.unit.en} of ${currentQ.item.en}`;
        document.getElementById('phrase-box').innerHTML = `<span class="g-${currentQ.unit.g}">${currentQ.numTxt}</span> <span id="target-blank" style="border-bottom:2px dashed #666; min-width:60px; display:inline-block;">[...]</span> <span class="g-${currentQ.item.g}">${currentQ.item.gs}</span>`;
        
        const opts = document.getElementById('options');
        opts.innerHTML = '';
        const choices = [currentQ.unit.s, currentQ.unit.pa, currentQ.unit.pb, currentQ.unit.gs].filter((v, i, a) => a.indexOf(v) === i).sort(() => Math.random() - 0.5);
        
        choices.forEach(o => {
            const b = document.createElement('button');
            b.className = 'opt-btn'; b.innerText = o;
            b.onclick = () => check(o);
            opts.appendChild(b);
        });
    }

    function check(choice) {
        const isCorrect = choice === currentQ.correct;
        if(isCorrect) { streak++; mastery[currentQ.item.pl] = (mastery[currentQ.item.pl] || 0) + 1; updateProgress(); }
        else { streak = 0; }
        
        document.getElementById('target-blank').innerHTML = `<span class="highlight-ans">${currentQ.correct}</span>`;
        document.getElementById('target-blank').style.borderBottom = "none";
        document.getElementById('streak-badge').innerText = `üî• ${streak}`;

        document.querySelectorAll('.opt-btn').forEach(b => {
            b.disabled = true;
            if(b.innerText === currentQ.correct) b.classList.add('correct');
            else if(b.innerText === choice) b.classList.add('wrong');
        });

        const ex = document.getElementById('expl');
        ex.style.display = 'block';
        ex.innerHTML = `<b>${isCorrect ? '‚úÖ' : '‚ùå'}</b> ${currentLang === 'en' ? 'Form for' : 'Forma dla'} <b>${currentQ.numTxt}</b> (${currentQ.unit.g}) = <b>${currentQ.correct}</b>.`;
        setTimeout(next, 3500);
    }
</script>
</body>
</html>
